<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>markdownComments.coffee</title>

  <link rel="stylesheet" href="../../assets/style.css">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"/>
  <meta name="groc-relative-root" content="../../"/>
  <meta name="groc-document-path" content="lib/transforms/markdownComments.coffee"/>
  
  <meta name="groc-repository-url" content="https://github.com/killercup/grock"/>
  
</head>
<body>
  <div id="file-area">
    <div id="meta">
      <code class="file-path">
      
        <a href="https://github.com/killercup/grock/blob/master/lib/transforms/markdownComments.coffee">lib/transforms/markdownComments.coffee</a>
      
      </code>
    </div>
    <div id="document">
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><h1 id="render-markdown-comments"><a href="#render-markdown-comments" class="anchor"></a>Render Markdown Comments</h1><p>Uses <a href="https://github.com/chjj/marked"><code>marked</code></a>.</p>
<p>This will render a file&#39;s segment&#39;s comments using markdown and add a list of
headlines to <code>file.exta.toc</code>.</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">Buffer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'buffer'</span>).Buffer
map = <span class="hljs-built_in">require</span>(<span class="hljs-string">'event-stream'</span>).map

hljs = <span class="hljs-built_in">require</span> <span class="hljs-string">'highlight.js'</span>
marked = <span class="hljs-built_in">require</span> <span class="hljs-string">'marked'</span>
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><h2 id="options"><a href="#options" class="anchor"></a>Options</h2><p>Highlight code in comments, e.g. examples</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">marked.setOptions
  <span class="hljs-attribute">highlight</span>: <span class="hljs-function"><span class="hljs-params">(code, lang)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> lang
      <span class="hljs-keyword">try</span>
        code = hljs.highlight(lang, code, <span class="hljs-literal">true</span>).value
      <span class="hljs-keyword">catch</span> e
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">try</span>
        code = hljs.highlightAuto(code).value
      <span class="hljs-keyword">catch</span> e
      
    <span class="hljs-keyword">return</span> code
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><h2 id="custom-renderer"><a href="#custom-renderer" class="anchor"></a>Custom Renderer</h2></div>
        </div>
      
      
        <div class="code"><div class="wrapper">renderer = <span class="hljs-keyword">new</span> marked.Renderer()
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments doc-section">
          <div class="wrapper"><p><span class='doc-section-header'>Method: <code>Render TODO Lists</code></span></p>
<p>Parameters:</p>
<ul>
<li><strong><code>text</code> must be a String.</strong><br/>(The input text of the list item)</li>
</ul>
<p><strong>Returns a String</strong><br/>(List item (possibly with checkboxes))</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">renderer.<span class="hljs-function"><span class="hljs-title">listitem</span> = <span class="hljs-params">(text)</span> -&gt;</span>
  text = text.replace <span class="hljs-regexp">/^\[x\] /</span>, <span class="hljs-string">'&lt;input type="checkbox" checked disabled/&gt; '</span>
  text = text.replace <span class="hljs-regexp">/^\[ \] /</span>, <span class="hljs-string">'&lt;input type="checkbox" disabled/&gt; '</span>
  <span class="hljs-keyword">return</span> <span class="hljs-string">"&lt;li&gt;<span class="hljs-subst">#{text}</span>&lt;/li&gt;\n"</span>
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments doc-section">
          <div class="wrapper"><p><span class='doc-section-header'>Method: <code>Set Heading Renderer</code></span></p>
<p>Parameters:</p>
<ul>
<li><strong><code>renderer</code> must be a marked.Renderer.</strong></li>
<li><strong><code>toc</code> must be an Array.</strong><br/>(Array of headlines, for table of contents)</li>
</ul>
<p><strong>Returns a String</strong><br/>(The rendered headline)</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-title">setHeadingRenderer</span> = <span class="hljs-params">(renderer, toc)</span> -&gt;</span>
  renderer.<span class="hljs-function"><span class="hljs-title">heading</span> = <span class="hljs-params">(text, level)</span> -&gt;</span></div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>Trim HTML Tags from heading</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">    heading = text.replace(<span class="hljs-regexp">/&lt;(?:.|\n)*?&gt;/gm</span>, <span class="hljs-string">''</span>)</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>Remove spaces to form slug</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">    slug = heading.toLowerCase().replace(<span class="hljs-regexp">/[^\w]+/g</span>, <span class="hljs-string">'-'</span>)

    toc.push <span class="hljs-attribute">level</span>: level, <span class="hljs-attribute">slug</span>: slug, <span class="hljs-attribute">title</span>: heading

    <span class="hljs-keyword">return</span> <span class="hljs-string">"""&lt;h<span class="hljs-subst">#{level}</span> id="<span class="hljs-subst">#{slug}</span>"&gt;&lt;a href="#<span class="hljs-subst">#{slug}</span>" class="anchor"&gt;&lt;/a&gt;<span class="hljs-subst">#{text}</span>&lt;/h<span class="hljs-subst">#{level}</span>&gt;"""</span>

<span class="hljs-built_in">module</span>.<span class="hljs-function"><span class="hljs-title">exports</span> = <span class="hljs-params">(options)</span> -&gt;</span></div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>Annotate an array of segments by running their comments through
<a href="https://github.com/chjj/marked">marked</a>.</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">  <span class="hljs-function"><span class="hljs-title">modifyFile</span> = <span class="hljs-params">(file, cb)</span> -&gt;</span>
    file.extra <span class="hljs-keyword">or</span>= {}
    toc = file.extra.toc <span class="hljs-keyword">or</span>= []
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>Skip unnecessary Markdown rendering (e.g. for JSON files)</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">    lang = file.extra.lang <span class="hljs-keyword">or</span> {}
    <span class="hljs-keyword">return</span> cb(<span class="hljs-literal">null</span>, file) <span class="hljs-keyword">if</span> lang.codeOnly
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>No comment(s)</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">    <span class="hljs-keyword">return</span> cb(<span class="hljs-literal">null</span>, file) <span class="hljs-keyword">unless</span> file.segments?.length

    <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> file.segments
      <span class="hljs-keyword">continue</span> <span class="hljs-keyword">unless</span> s.comments?.length

      setHeadingRenderer(renderer, toc)
      s.comments = marked s.comments.join(<span class="hljs-string">'\n'</span>), <span class="hljs-attribute">renderer</span>: renderer

    cb(<span class="hljs-literal">null</span>, file)

  <span class="hljs-keyword">return</span> map(modifyFile)
</div></div>
      
      </div>
    
    </div>
  </div>

  <script src="../../toc.js"></script>
  <script src="../../assets/libs.js"></script>
  <script src="../../assets/behavior.js"></script>
</body>
</html>